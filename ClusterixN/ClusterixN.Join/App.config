<?xml version="1.0" encoding="utf-8"?>

<configuration>

  <configSections>
    <section name="ListenersConfiguration"
             type="ClusterixN.Common.Configuration.Listener.ListenersConfigSection, ClusterixN.Common" />
    <section name="ConnectionsConfiguration"
             type="ClusterixN.Common.Configuration.Connection.ConnectionsConfigSection, ClusterixN.Common" />
    <section name="ClusterixN.Common"
             type="ClusterixN.Common.Configuration.ConfigurationElement.BaseServicesConfigurationSectionHandler, ClusterixN.Common" />
    <section name="nlog" type="NLog.Config.ConfigSectionHandler, NLog" />
  </configSections>

  <ClusterixN.Common>
    <add key="ClusterixN.Common.Interfaces.ILogService"
         value="ClusterixN.Infrastructure.Logging.NLogService, ClusterixN.Infrastructure.Logging" />
    <add key="ClusterixN.Common.Interfaces.IConfigurationService"
         value="ClusterixN.Common.Configuration.ConfigurationService, ClusterixN.Common" />
    <add key="ClusterixN.Common.Interfaces.IDatabaseService"
         value="ClusterixN.Database.MySQL8.DatabaseService, ClusterixN.Database.MySQL8" />
    <add key="ClusterixN.Common.Interfaces.IHasher"
         value="ClusterixN.Common.Utils.Hasher.SequenceHashHelper, ClusterixN.Common" />
    <!--<add key="ClusterixN.Common.Interfaces.IHasher"
         value="ClusterixN.Common.Utils.Hasher.ParallelHashHelper, ClusterixN.Common" />-->
  </ClusterixN.Common>

  <nlog xmlns="http://www.nlog-project.org/schemas/NLog.xsd" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        throwExceptions="true">
    <variable name="ApplicationDir" value="."></variable>
    <targets>
      <target name="logfile" xsi:type="File"
              fileName="debug_join.log"
              layout="[${longdate}] ${level:uppercase=true} ${callsite:skipFrames=1} ${message} ${onexception:\n\rEXCEPTION OCCURRED:${exception:format=type,message,method:maxInnerExceptionLevel=5:innerFormat=shortType,message,method}}"
              archiveEvery="Day"
              archiveDateFormat="yyyyMMdd"
              archiveFileName="archive_join_{#}.log"
              archiveNumbering="Date"
              encoding="utf-8"
              fileNameKind="Relative"
              maxArchiveFiles="14"
              keepFileOpen="false" />
      <target name="timeCsv" xsi:type="File" fileName="times.csv"
              archiveFileName="times.{####}.csv"
              archiveNumbering="Sequence" >
        <layout xsi:type="CSVLayout">
          <column name="time" layout="${longdate}" />
          <column name="logger" layout="${logger}"/>
          <column name="level" layout="${level}"/>
          <column name="message" layout="${message}" />
        </layout>
      </target>
      <target name="PerfDatabase" xsi:type="Database" keepConnection="false"
              useTransactions="false"
              dbProvider="System.Data.SQLite.SQLiteConnection, System.Data.SQLite"
              connectionString="Data Source=performance.db;Version=3;"
              commandText="INSERT INTO performance(Timestamp, Module, Counter, `Value`) 
              VALUES(@Timestamp, @Module, @Counter, @Value)">
        <parameter name="@Timestamp" layout="${event-properties:Time:format=yyyy-MM-dd HH\:mm\:ss.fff}"/>
        <parameter name="@Module" layout="${event-properties:Module}"/>
        <parameter name="@Counter" layout="${event-properties:Counter}"/>
        <parameter name="@Value" layout="${event-properties:Value}"/>
      </target>
      <target name="AsyncDatabase" xsi:type="AsyncWrapper" queueLimit="10000" batchSize="200" overflowAction="Block">
      <target name="Database" xsi:type="Database" keepConnection="false"
              useTransactions="true"
              dbProvider="System.Data.SQLite.SQLiteConnection, System.Data.SQLite"
              connectionString="Data Source=timeLog.db;Version=3;"
              commandText="INSERT INTO times(Timestamp, Module, Operation, `From`, `To`, QueryId, SubQueryId, RelationId, Duration) 
              VALUES(@Timestamp, @Module, @Operation, @From, @To, @QueryId, @SubQueryId, @RelationId, @Duration)">
        <parameter name="@Timestamp" layout="${event-properties:Time:format=yyyy-MM-dd HH\:mm\:ss.fff}"/>
        <parameter name="@Module" layout="${event-properties:Module}"/>
        <parameter name="@Operation" layout="${event-properties:Operation}"/>
        <parameter name="@From" layout="${event-properties:From}"/>
        <parameter name="@To" layout="${event-properties:To}"/>
        <parameter name="@QueryId" layout="${event-properties:QueryId}"/>
        <parameter name="@SubQueryId" layout="${event-properties:SubQueryId}"/>
        <parameter name="@RelationId" layout="${event-properties:RelationId}"/>
        <parameter name="@Duration" layout="${event-properties:Duration}"/>
      </target>
      </target>
      <target name="console" xsi:type="ColoredConsole"
              layout="[${longdate}] ${level:uppercase=true} ${callsite:skipFrames=1} ${message} ${onexception:\n\rEXCEPTION OCCURRED:${exception:format=type,message,method:maxInnerExceptionLevel=5:innerFormat=shortType,message,method}}" />
    </targets>
    <rules>
      <logger name="defaultLogger" minlevel="Trace" writeTo="console" />
      <logger name="defaultLogger" minlevel="Trace" writeTo="logfile" />
      <logger name="timeLogger" minlevel="Trace" writeTo="AsyncDatabase" />
      <logger name="performanceLogger" minlevel="Trace" writeTo="PerfDatabase" />
    </rules>
  </nlog>

  <ConnectionsConfiguration>
    <Connections>
      <!--<add name="DefaultServer" address="localhost" port="1235" />-->
      <add name="DefaultServer" address="localhost" port="1234" />
    </Connections>
  </ConnectionsConfiguration>
  
  <ListenersConfiguration>
    <Listeners>
      <add name="DefaultListener" port="10002" />
    </Listeners>
  </ListenersConfiguration>

  <connectionStrings>
    <add name="Postgres"
         connectionString="Server=localhost;Port=5432;Database=postgres;User ID=postgres;Password=postgres;" />
    <add name="MonetDB"
         connectionString="dsn=MonetDB;HOST=localhost;PORT=50000;UID=monetdb; PWD=monetdb" />
    <add name="MySQL"
         connectionString="Server=localhost;Uid=root;Pwd=;ConnectionTimeout=86400;Database=join;DefaultCommandTimeout=86400;AllowUserVariables=true;port=3306" />
  </connectionStrings>

  <appSettings>
    <add key="ActiveConnection" value="MySQL"/>
    <add key="ModuleName" value="JOIN_1"/>
    <add key="BlockSize" value="1000000"/>
    <add key="DataDir" value="tmp"/>
    <add key="IsHardNode" value="1"/>
    <add key="MinRamAvaible" value="5" />
    <add key="SyncDelete" value="1"/>
    <add key="MySQL_Engine" value="MEMORY" />
    <add key="WorkMode" value="Hash" />
    <add key="IsManagedJoin" value="1" />
    <add key="MergeBlocksIntoOneFile" value="1" />
    <add key="WorkCoresCount" value="2" />
    <add key="HashQueueBind" value="0" />
    <add key="IndexRelationsAfterLoad" value="0" />
  </appSettings>

</configuration>