<?xml version="1.0" encoding="utf-8"?>

<configuration>
  
  <configSections>
    <section name="ListenersConfiguration"
             type="ClusterixN.Configuration.Listener.ListenersConfigSection, ClusterixN.Configuration" />
    <section name="ConnectionsConfiguration"
             type="ClusterixN.Configuration.Connections.ConnectionConfigSection, ClusterixN.Configuration" />
    <section name="ClusterixN.Infrastructure"
             type="ClusterixN.Infrastructure.ConfigurationElement.BaseServicesConfigurationSectionHandler, ClusterixN.Infrastructure" />
    <section name="nlog" type="NLog.Config.ConfigSectionHandler, NLog" />
  </configSections>

  <ClusterixN.Infrastructure>
    <add key="ClusterixN.Infrastructure.Interfaces.ILogService"
         value="ClusterixN.Infrastructure.Logging.NLogService, ClusterixN.Infrastructure.Logging" />
    <add key="ClusterixN.Infrastructure.Interfaces.IConfigurationService"
         value="ClusterixN.Infrastructure.ConfigurationService, ClusterixN.Infrastructure" />
  </ClusterixN.Infrastructure>

  <nlog xmlns="http://www.nlog-project.org/schemas/NLog.xsd" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        throwExceptions="true">
    <variable name="ApplicationDir" value="."></variable>
    <targets>
      <target name="logfile" xsi:type="File"
              fileName="debug_manager.log"
              layout="[${longdate}] ${level:uppercase=true} ${callsite:skipFrames=1} ${message} ${onexception:\n\rEXCEPTION OCCURRED:${exception:format=type,message,method:maxInnerExceptionLevel=5:innerFormat=shortType,message,method}}"
              archiveEvery="Day"
              archiveDateFormat="yyyyMMdd"
              archiveFileName="archive_manager_{#}.log"
              archiveNumbering="Date"
              encoding="utf-8"
              fileNameKind="Relative"
              maxArchiveFiles="14"
              keepFileOpen="false" />
      <target name="timelogfile" xsi:type="File"
              fileName="times_manager.log"
              layout="[${longdate}] ${message}"
              archiveEvery="Day"
              archiveDateFormat="yyyyMMdd"
              archiveFileName="archive_times_manager_{#}.log"
              archiveNumbering="Date"
              encoding="utf-8"
              fileNameKind="Relative"
              maxArchiveFiles="14"
              keepFileOpen="false" />
      <target name="console" xsi:type="Console"
              layout="[${longdate}] ${level:uppercase=true} ${callsite:skipFrames=1} ${message} ${onexception:\n\rEXCEPTION OCCURRED:${exception:format=type,message,method:maxInnerExceptionLevel=5:innerFormat=shortType,message,method}}" />
      <target name="Database" xsi:type="Database" keepConnection="false"
              useTransactions="false"
              dbProvider="System.Data.SQLite.SQLiteConnection, System.Data.SQLite"
              connectionString="Data Source=timeLog.db;Version=3;"
              commandText="INSERT INTO times(Timestamp, Module, Operation, `From`, `To`, QueryId, SubQueryId, RelationId, Duration) 
              VALUES(@Timestamp, @Module, @Operation, @From, @To, @QueryId, @SubQueryId, @RelationId, @Duration)">
        <parameter name="@Timestamp" layout="${event-properties:Time:format=yyyy-MM-dd HH\:mm\:ss.fff}"/>
        <parameter name="@Module" layout="${event-properties:Module}"/>
        <parameter name="@Operation" layout="${event-properties:Operation}"/>
        <parameter name="@From" layout="${event-properties:From}"/>
        <parameter name="@To" layout="${event-properties:To}"/>
        <parameter name="@QueryId" layout="${event-properties:QueryId}"/>
        <parameter name="@SubQueryId" layout="${event-properties:SubQueryId}"/>
        <parameter name="@RelationId" layout="${event-properties:RelationId}"/>
        <parameter name="@Duration" layout="${event-properties:Duration}"/>
      </target>
      </targets>
    <rules>
      <logger name="defaultLogger" minlevel="Info" writeTo="console" />
      <logger name="defaultLogger" minlevel="Info" writeTo="logfile" />
      <logger name="timeLogger" minlevel="Trace" writeTo="Database" />
      <logger name="mgmQueryTime" minlevel="Trace" writeTo="timelogfile" />
    </rules>
  </nlog>

  <ListenersConfiguration>
    <Listeners>
      <add name="DefaultListener" port="1234" />
    </Listeners>
  </ListenersConfiguration>

  <ConnectionsConfiguration>
    <Connections>
      <add name="DefaultServer" address="localhost" port="1234" />
    </Connections>
  </ConnectionsConfiguration>

  <startup>
    <supportedRuntime version="v4.0" sku=".NETFramework,Version=v4.0" />
  </startup>

  <appSettings>
    <add key="ModuleName" value="MGM_1"/>
  </appSettings>

</configuration>